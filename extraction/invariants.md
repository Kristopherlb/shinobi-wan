## Invariants

| ID | Title | Rationale | Evidence | V3 Mapping |
|---|---|---|---|---|
| INV-001 | Deterministic compilation outputs | Repeated runs over identical conceptual inputs must yield identical machine outputs; nondeterminism sources are controlled explicitly. | `extracted-kb/test-cases/README.md:L31-L38`; `packages/core/src/platform/services/artifact-serializer.ts:L13-L36`; `apps/svc/src/cli/utils/template-diff.ts:L200-L207`; `packages/components/sqs-queue/tests/security/cdk-nag.test.ts:L24-L38` | KernelLaw: KL-001 DeterministicCompilation |
| INV-002 | Schema is the contract | Manifests validate against schema as the single source of truth; schema failures produce structured, actionable errors. | `packages/core/src/services/pipeline.ts:L100-L127`; `packages/core/src/services/enhanced-schema-validator.ts:L93-L171`; `packages/core/src/services/service-manifest.schema.json:L1-L56` | KernelLaw: KL-002 SchemaAndSpecValidation |
| INV-003 | Unknown component types rejected | Unsupported component types are rejected with a diagnostic listing allowed types. | `packages/core/src/services/enhanced-schema-validator.ts:L239-L252` | KernelLaw: KL-002 SchemaAndSpecValidation; KL-006 ExplainableDiagnostics |
| INV-004 | Binding targets must exist | `binds[].to` references must point to an existing component name; missing targets are errors. | `packages/core/src/services/reference-validator.ts:L33-L44`; `packages/core/src/services/pipeline.ts:L156-L167` | KernelLaw: KL-002 SchemaAndSpecValidation; KL-006 ExplainableDiagnostics |
| INV-005 | `${ref:...}` references validated | `${ref:component.*}` expressions must refer to an existing component; invalid references are rejected early. | `packages/core/src/services/reference-validator.ts:L46-L90` | KernelLaw: KL-006 ExplainableDiagnostics |
| INV-006 | Plan artifact envelope is stable | Plan artifacts have a defined machine-readable envelope with validation and compliance summaries. | `packages/core/src/platform/contracts/artifacts.ts:L14-L29`; `packages/core/src/platform/contracts/artifacts.ts:L237-L274` | StandardHeading: Plan_Artifact_Envelope_And_Versioning |
| INV-007 | Artifact file layout is fixed | Artifact writer emits a deterministic, contractable file layout (plan, per-component, summary, validation, compliance). | `packages/core/src/platform/services/artifact-writer.ts:L24-L68` | StandardHeading: Deterministic_File_Layout |
| INV-008 | Directive structure validation exists | Binding/trigger directives have explicit required fields and structural validation. | `packages/core/src/platform/contracts/platform-binding-trigger-spec.ts:L398-L441`; `packages/core/src/services/binding-directive-validator.ts:L69-L93` | KernelLaw: KL-002 SchemaAndSpecValidation |
| INV-009 | Compatibility matrix enforced | Bind directives are rejected when no compatible binder exists; errors surface allowed capabilities when available. | `packages/core/src/services/binding-directive-validator.ts:L111-L138`; `packages/core/src/platform/contracts/platform-binding-trigger-spec.ts:L284-L329` | KernelLaw: KL-003 CapabilityCompatibilityMatrix |
| INV-010 | Access level validated | Access levels must match the declared compatibility matrix; invalid access values are rejected with allowed values. | `packages/core/src/services/binding-directive-validator.ts:L141-L256` | KernelLaw: KL-003 CapabilityCompatibilityMatrix; KL-006 ExplainableDiagnostics |
| INV-011 | Action profiles are pack-driven | Action profile names resolve through framework pack config; unknown profiles are rejected with remediation guidance. | `packages/core/src/platform/binders/action-profiles.ts:L37-L72`; `packages/core/src/services/binding-directive-validator.ts:L261-L327`; `config/commercial.yml:L1-L14` | KernelLaw: KL-008 PolicyPackDrivenCompliance; Pattern: P-001 AccessLevelToActions |
| INV-012 | Options schema is capability-scoped | Directive `options` are validated against capability-specific schemas; unknown capability options are rejected. | `packages/core/src/platform/contracts/directive-schema-validator.ts:L64-L90` | KernelLaw: KL-002 SchemaAndSpecValidation; KL-006 ExplainableDiagnostics |
| INV-013 | Env injection has guardrails | Directive env mappings block sensitive variables; allow-lists are enforced when defined. | `packages/core/src/platform/contracts/directive-schema-validator.ts:L93-L125`; `packages/core/src/platform/contracts/directive-schema-validator.ts:L144-L307` | KernelLaw: KL-006 ExplainableDiagnostics |
| INV-014 | Directives are immutable post-validate | Directives are deep-frozen after validation to prevent tampering during synthesis/binding. | `packages/core/src/platform/contracts/directive-schema-validator.ts:L134-L137`; `packages/core/src/platform/contracts/directive-schema-validator.ts:L315-L328` | KernelLaw: KL-001 DeterministicCompilation |
| INV-015 | Compliance pack precedence is defined | Compliance rules load from packs with precedence (override → custom → built-in → fallback) and explicit override restriction in higher-assurance frameworks. | `packages/core/src/platform/contracts/compliance/rules.ts:L7-L13`; `packages/core/src/platform/contracts/compliance/rules.ts:L70-L127`; `packages/core/src/platform/contracts/unified-binder-strategy-base.ts:L177-L236` | KernelLaw: KL-008 PolicyPackDrivenCompliance |
| INV-016 | Compliance status is mandatory | Binding results include a mandatory, machine-readable compliance block with actions/violations. | `packages/core/src/platform/contracts/platform-binding-trigger-spec.ts:L166-L187` | KernelLaw: KL-008 PolicyPackDrivenCompliance |
| INV-017 | Least privilege is enforced | Binder wrapper validates IAM statements for unsafe resource patterns and flags least-privilege violations. | `packages/core/src/platform/contracts/unified-binder-strategy-base.ts:L103-L133`; `packages/core/src/platform/contracts/unified-binder-strategy-base.ts:L569-L633` | KernelLaw: KL-005 LeastPrivilegeByConstruction |
| INV-018 | Suppressions require governance fields | Governance suppressions require `id`, `justification`, `owner`, `expiresOn`, and strict ISO date validation. | `packages/core/src/services/reference-validator.ts:L53-L68`; `packages/core/src/services/reference-validator.ts:L108-L116` | StandardHeading: Exception_Record_Schema |
| INV-019 | Patches are registered and expiring | Escape-hatch patches are registered in the manifest with justification/owner/expiry and a minimum justification length. | `packages/core/src/services/service-manifest.schema.json:L224-L264` | StandardHeading: Patch_Registration_Schema |
| INV-020 | Audit records are schema-locked | Governance audit records are strict schemas (no additional properties) with required actor/action/resource/outcome/context fields. | `packages/governance/src/schemas/audit-record.schema.json:L4-L56` | StandardHeading: Immutable_Audit_Record_Schema |
| INV-021 | Canonical ordering is mandatory | Collections are ordered deterministically prior to evaluation and serialization to prevent reorder-only drift. | `apps/svc/src/cli/utils/template-diff.ts:L200-L207`; `packages/core/src/platform/services/feature-flags/feature-flag.service.ts:L678-L691`; `extracted-kb/test-cases/README.md:L33-L34` | KernelLaw: KL-001 DeterministicCompilation |
| INV-022 | Kernel outputs are backend-neutral | Kernel/binder outputs must not contain backend-native objects or handles; lowering is adapter-only. | `extracted-kb/test-cases/README.md:L7-L9`; `extracted-kb/test-cases/README.md:L36-L37`; `extracted-kb/shinobi-v3-required-standards-inventory.md:L73-L86` | KernelLaw: KL-004 DerivedIntentBoundary |

## Exit Criteria

- [ ] All core validators classified (schema, directives, references, binding directives).
- [ ] All compliance pack loaders + override restrictions classified.
- [ ] Artifact contracts + writer/serializer classified.
- [ ] Representative determinism evidence classified (tests and/or serializers).
- [ ] Governance evidence classified (audit record, suppressions, patches).

## Open Questions

- Does V3 treat `actionProfiles` + `actionAllowLists` as Kernel Laws (hard enforcement) or a portable Pattern with policy-driven enforcement? (Evidence: `config/commercial.yml:L1-L60`; `packages/core/src/services/binding-directive-validator.ts:L261-L327`)
- `service-manifest.schema.json` restricts `complianceFramework` via enum while `ComplianceFramework` is `string` in `bindings.ts`; should V3 manifest accept arbitrary framework strings by default? (Evidence: `packages/core/src/services/service-manifest.schema.json:L21-L30`; `packages/core/src/platform/contracts/bindings.ts:L51-L65`)
- Binder compliance evaluation includes a hard-coded rule-name switch; is this an acceptable V2 implementation detail to drop (Legacy) or an intentionally preserved Pattern for “unknown rules are implicitly satisfied”? (Evidence: `packages/core/src/platform/contracts/unified-binder-strategy-base.ts:L460-L473`)

